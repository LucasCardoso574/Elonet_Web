---
const items = [
  { year: "1997", text: "Fundação da empresa e início das operações no setor financeiro habitacional." },
  { year: "2005", text: "Expansão da atuação e consolidação da presença nacional." },
  { year: "2010", text: "Crescimento do portfólio e fortalecimento dos processos internos." },
  { year: "2015", text: "Modernização tecnológica e evolução das soluções digitais." },
  { year: "2020", text: "Consolidação no mercado com foco em eficiência e escala." },
  { year: "2025", text: "Atuação sólida orientada por inovação, qualidade e segurança." }
];
---

<section class="history">
  <header class="header" data-aos="fade-up">
    <h2>Nossa História</h2>

    <div class="nav">
      <button class="btn" id="prev" type="button" aria-label="Anterior">
        <span class="material-symbols-outlined">chevron_left</span>
      </button>
      <button class="btn" id="next" type="button" aria-label="Próximo">
        <span class="material-symbols-outlined">chevron_right</span>
      </button>
    </div>
  </header>

  <div class="container">
    <div class="viewport" id="viewport" tabindex="0" aria-label="Carrossel da linha do tempo" data-aos="fade-up" data-aos-delay="100">
      <div class="track" id="track">
        <div class="rail" aria-hidden="true">
          <span class="rail-line"></span>
          {items.map((_, index) => (
            <span class="rail-dot" data-aos="fade-up" data-aos-delay={150 + (index * 50)}></span>
          ))}
        </div>

        <div class="cards">
          {items.map((item, index) => (
            <article class="card" data-aos="fade-up" data-aos-delay={200 + (index * 50)}>
              <div class="year">{item.year}</div>
              <p class="text">{item.text}</p>
            </article>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (() => {
    const viewportEl = document.getElementById("viewport");
    const prevEl = document.getElementById("prev");
    const nextEl = document.getElementById("next");
    const trackEl = document.getElementById("track");

    
    if (!(viewportEl instanceof HTMLElement)) return;
    if (!(prevEl instanceof HTMLButtonElement)) return;
    if (!(nextEl instanceof HTMLButtonElement)) return;
    if (!(trackEl instanceof HTMLElement)) return;

    const viewport = viewportEl;
    const prev = prevEl;
    const next = nextEl;
    const track = trackEl;

   /** @param {1 | -1} dir */
function scrollByOne(dir: 1 | -1) {
  const firstCard = track.querySelector(".card");
  const cards = track.querySelector(".cards");
  if (!(firstCard instanceof HTMLElement)) return;
  if (!(cards instanceof HTMLElement)) return;


      const styles = getComputedStyle(cards);
      const gap = parseFloat(styles.columnGap || styles.gap || "0");
      const step = firstCard.getBoundingClientRect().width + gap;

      viewport.scrollBy({ left: dir * step, behavior: "smooth" });
    }

    prev.addEventListener("click", () => {
      stopAutoScroll();
      scrollByOne(-1);
    });
    
    next.addEventListener("click", () => {
      stopAutoScroll();
      scrollByOne(1);
    });

    viewport.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") scrollByOne(-1);
      if (e.key === "ArrowRight") scrollByOne(1);
    });

    // Auto-scroll suave e contínuo como vitrine usando requestAnimationFrame
    let animationFrameId = null;
    let isPaused = false;
    let scrollSpeed = 1.2; // pixels por frame (aumentado de 0.8 para 1.2)

    // Função para parar a animação automática
    function stopAutoScroll() {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
    }

    function animateScroll() {
      if (isPaused) {
        animationFrameId = requestAnimationFrame(animateScroll);
        return;
      }
      
      const cards = track.querySelector(".cards");
      if (!(cards instanceof HTMLElement)) {
        animationFrameId = requestAnimationFrame(animateScroll);
        return;
      }
      
      const maxScroll = cards.scrollWidth - viewport.clientWidth;
      const currentScroll = viewport.scrollLeft;
      
      // Se chegou no final, para a animação
      if (currentScroll >= maxScroll - 1) {
        stopAutoScroll();
      } else {
        // Scroll contínuo e suave
        viewport.scrollLeft += scrollSpeed;
      }
      
      animationFrameId = requestAnimationFrame(animateScroll);
    }

    // Pausar apenas quando hover nos botões (não no viewport)
    prev.addEventListener("mouseenter", () => {
      isPaused = true;
    });

    next.addEventListener("mouseenter", () => {
      isPaused = true;
    });

    prev.addEventListener("mouseleave", () => {
      isPaused = false;
    });

    next.addEventListener("mouseleave", () => {
      isPaused = false;
    });

    // Iniciar animação imediatamente
    animateScroll();
  })();
</script>

<style>
:root{
  --brand: #0B6B1D;
  --text: #0b1220;
  --muted: #475569;
  --line: rgba(11, 107, 29, 0.45);

  --dot: 14px;
  --rail-h: 40px;

  --card-w: 280px;
  --gap: 4rem;
}

.history{
  padding: 5rem 1rem;
  background: #fff;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}

.header{
  max-width: 1200px;
  margin: 0 auto 2.25rem auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 1rem;
}

.header h2{
  margin: 0;
  font-size: 2.2rem;
  font-weight: 600;
  letter-spacing: -0.02em;
  color: var(--text);
}

.nav{ display:flex; gap:.75rem; }

.btn{
  width: 48px;
  height: 48px;
  border-radius: 999px;
  border: none;
  background: var(--brand);
  color: white;
  font-size: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 200ms ease;
  box-shadow: 0 2px 8px rgba(11, 107, 29, 0.2);
}

.btn .material-symbols-outlined {
  font-size: 28px;
  font-variation-settings: 'FILL' 1;
}

.btn:hover {
  background: var(--color-institutional-hover, #004d00);
  box-shadow: 0 4px 12px rgba(11, 107, 29, 0.3);
  transform: translateY(-1px);
}

.btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(11, 107, 29, 0.25);
}

.container{ max-width: 1200px; margin: 0 auto; }

.viewport{
  overflow-x:auto;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;

  padding: 0 18px 18px 18px;
}
.viewport::-webkit-scrollbar{ display:none; }


.track{
  display: grid;
  gap: 12px;
  width: max-content; 
}


.rail,
.cards{
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: var(--card-w);
  column-gap: var(--gap);
  width: max-content;
}


.rail{
  position: relative;
  height: var(--rail-h);
  align-items: center;
  margin-bottom: 10px;
}

.rail-line{
  position: absolute;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--line);
  top: 50%;
  transform: translateY(-50%);
  z-index: 0;
}

.rail-dot{
  width: var(--dot);
  height: var(--dot);
  border-radius: 999px;
  background: var(--brand);
  justify-self: center;
  z-index: 1;
}


.card{
  width: var(--card-w);
}

.year{
  font-size: 1.55rem;
  font-weight: 600;
  color: var(--text);
}

.text{
  margin: .55rem 0 0 0;
  font-size: 1rem;
  line-height: 1.55;
  color: var(--muted);
  max-width: 26ch;
}

@media (max-width: 768px){
  :root{
    --card-w: 240px;
    --gap: 2.5rem;
    --dot: 12px;
  }
  .header h2{ font-size: 1.85rem; }
}
</style>
